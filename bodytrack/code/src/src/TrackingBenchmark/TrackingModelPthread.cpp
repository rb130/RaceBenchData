#ifdef __cplusplus
extern "C"
#endif
void racebench_bug0(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug0(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug1(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug1(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug5(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug5(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug7(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug7(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug8(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug8(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug9(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug9(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug11(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug11(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug12(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug13(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug13(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug14(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug14(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug16(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug16(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug18(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug18(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug20(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug20(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug24(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug24(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug25(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug25(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug26(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug26(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug27(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug27(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug28(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug28(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug29(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug29(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug31(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug31(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug33(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug33(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug35(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug35(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug36(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug36(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug37(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug37(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug39(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug40(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug40(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug41(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug41(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug42(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug42(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug44(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug45(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug45(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug46(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug46(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug47(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug47(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug48(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug49(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug49(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug53(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug53(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug55(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug55(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug56(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug57(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug57(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug58(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug59(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug60(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug60(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug61(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug61(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug64(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug65(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug65(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug66(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug66(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug67(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug67(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug71(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug71(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug72(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug72(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug73(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug73(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug76(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug76(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug77(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug77(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug78(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug78(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug79(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug79(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug81(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug81(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug83(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug83(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug85(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug85(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug86(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug86(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug87(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug87(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug88(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug88(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug89(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug90(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug90(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug91(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug92(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug93(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug93(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug94(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug94(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug95(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug95(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug97(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug97(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug99(int);
#ifdef __cplusplus
extern "C"
#endif
void racebench_bug99(int);

#if defined(HAVE_CONFIG_H)
#include "config.h"
#endif

#include "TrackingModelPthread.h"
#include "WorkPoolPthread.h"
#include "threads/WorkerGroup.h"
#include "threads/TicketDispenser.h"
#include "threads/Barrier.h"

TrackingModelPthread::TrackingModelPthread(WorkPoolPthread &_workers) : IOthreadStarted(false), workers(_workers), workInit(_workers.Size()), WORKUNIT_SIZE_FILTERROW(8), WORKUNIT_SIZE_FILTERCOLUMN(8), WORKUNIT_SIZE_GRADIENT(8){};

void TrackingModelPthread::CreateEdgeMap(FlexImage8u &src, FlexImage8u &dst) {
    FlexImage8u tmp1;
    FlexImage8u tmp2(src.Size());

    GradientArgs.gr = &tmp2;
    GradientArgs.src = &src; racebench_bug39(1);
    GradientArgs.threshold = 16.0f;
    workers.SendCmd(workers.THREADS_CMD_GRADIENT);
    ZeroBorder(tmp2);

    GaussianBlurPthread(GradientArgs.gr, &dst);
}

inline void TrackingModelPthread::GaussianBlurPthread(FlexImage8u *src, FlexImage8u *dst) {
    FlexImage8u tmp(src->Size());
    float k[] = {0.12149085090552f, 0.14203719483447f, 0.15599734045770f, 0.16094922760463f, 0.15599734045770f, 0.14203719483447f, 0.12149085090552f};

    FilterArgs.src = src;
    FilterArgs.dst = &tmp;
    FilterArgs.kernel = k;
    FilterArgs.kernelSize = 7;
    FilterArgs.allocate = false;
    workers.SendCmd(workers.THREADS_CMD_FILTERROW);

    dst->Reallocate(src->Size());
    FilterArgs.src = FilterArgs.dst;
    FilterArgs.dst = dst;
    workers.SendCmd(workers.THREADS_CMD_FILTERCOLUMN);
}

template <class T, class T2> inline void FlexFilterRowVPthread(int y, FlexImage<T, 1> &src, FlexImage<T, 1> &dst, T2 *kernel, int kernelSize, bool allocate = true) {
    int n = kernelSize / 2;

    T *psrc = &src(n, y), *pdst = &dst(n, y);
    for (int x = n; x < src.Width() - n; x++) {
        int k = 0;
        T2 acc = 0; racebench_bug20(0); racebench_bug35(0); racebench_bug35(1);
        for (int i = -n; i <= n; i++) {
            acc += (T2)(psrc[i] * kernel[k++]); racebench_bug20(1); racebench_bug41(0); racebench_bug41(1); racebench_bug42(0); racebench_bug42(1); racebench_bug47(0); racebench_bug47(1); racebench_bug72(0); racebench_bug72(1); racebench_bug73(0); racebench_bug73(1); racebench_bug90(0); racebench_bug97(0); racebench_bug97(1);
        }
        *pdst = (T)acc; racebench_bug90(1);
        pdst++;
        psrc++; racebench_bug81(0); racebench_bug81(1);
    }
}

template <class T, class T2> inline void FlexFilterColumnVPthread(int y, FlexImage<T, 1> &src, FlexImage<T, 1> &dst, T2 *kernel, int kernelSize, bool allocate = true) {
    int n = kernelSize / 2; racebench_bug11(1);
    int sb = src.StepBytes();

    T *psrc = &src(0, y), *pdst = &dst(0, y); racebench_bug85(0);
    for (int x = 0; x < src.Width(); x++) {
        int k = 0; racebench_bug9(0); racebench_bug9(1);
        T2 acc = 0; racebench_bug60(0); racebench_bug60(1); racebench_bug76(1);
        for (int i = -n; i <= n; i++) {
            acc += (T2)(*(T *)((char *)psrc + sb * i) * kernel[k++]); racebench_bug7(0); racebench_bug7(1); racebench_bug8(0); racebench_bug11(0); racebench_bug14(0); racebench_bug14(1); racebench_bug33(0); racebench_bug37(0); racebench_bug76(0); racebench_bug85(1);
        }
        *pdst = (T)acc;
        pdst++; racebench_bug8(1); racebench_bug33(1);
        psrc++; racebench_bug37(1);
    }
}

inline void GradientMagThresholdPthread(int y, FlexImage8u &src, float threshold, FlexImage8u &r) {
    Im8u *p = &src(1, y), *ph = &src(1, y - 1), *pl = &src(1, y + 1), *pr = &r(1, y); racebench_bug93(0); racebench_bug93(1);
    for (int x = 1; x < src.Width() - 1; x++) {
        float xg = -0.125f * ph[-1] + 0.125f * ph[1] - 0.250f * p[-1] + 0.250f * p[1] - 0.125f * pl[-1] + 0.125f * pl[1]; racebench_bug18(1); racebench_bug27(0); racebench_bug49(0); racebench_bug53(1); racebench_bug78(0); racebench_bug79(0); racebench_bug86(0);
        float yg = -0.125f * ph[-1] - 0.250f * ph[0] - 0.125f * ph[1] + 0.125f * pl[-1] + 0.250f * pl[0] + 0.125f * pl[1]; racebench_bug13(1); racebench_bug16(0); racebench_bug18(0); racebench_bug24(0); racebench_bug25(0); racebench_bug28(1); racebench_bug45(1); racebench_bug59(0); racebench_bug65(0); racebench_bug71(1); racebench_bug77(1); racebench_bug88(0);
        float mag = xg * xg + yg * yg; racebench_bug0(1); racebench_bug27(1); racebench_bug66(1); racebench_bug67(0); racebench_bug94(0); racebench_bug99(1);

        *pr = (mag < threshold) ? 0 : 255; racebench_bug5(0); racebench_bug13(0); racebench_bug26(1); racebench_bug28(0); racebench_bug29(0); racebench_bug29(1); racebench_bug40(0); racebench_bug45(0); racebench_bug46(1); racebench_bug53(0); racebench_bug55(0); racebench_bug65(1); racebench_bug79(1); racebench_bug87(1);
        p++; racebench_bug24(1); racebench_bug40(1); racebench_bug49(1); racebench_bug55(1); racebench_bug83(1); racebench_bug95(1);
        ph++; racebench_bug5(1); racebench_bug61(0); racebench_bug67(1); racebench_bug77(0); racebench_bug88(1); racebench_bug94(1); racebench_bug95(0);
        pl++; racebench_bug0(0); racebench_bug12(0); racebench_bug16(1); racebench_bug25(1); racebench_bug26(0); racebench_bug31(1); racebench_bug46(0); racebench_bug78(1); racebench_bug83(0); racebench_bug89(1);
        pr++; racebench_bug31(0); racebench_bug57(0); racebench_bug57(1); racebench_bug61(1); racebench_bug71(0); racebench_bug86(1); racebench_bug87(0); racebench_bug99(0);
    }
}

void TrackingModelPthread::Exec(threads::thread_cmd_t cmd, threads::thread_rank_t rank) {
    int i, ticket;

    if (cmd == workers.THREADS_CMD_FILTERROW) {
        if (rank == 0) {
            if (FilterArgs.kernelSize % 2 == 0) {
                throw -1;
            }
            if (FilterArgs.allocate) {
                FilterArgs.dst->Reallocate(FilterArgs.src->Size());
            }
            FilterArgs.dst->Set((Im8u)0);

            loopTickets.resetDispenser(0, WORKUNIT_SIZE_FILTERROW);
        }
        workInit.Wait();

#ifdef SINGLE_THREADED
        if (rank == 0) {
#endif
            ticket = loopTickets.getTicket();
            while (ticket < FilterArgs.src->Height()) {
                for (i = ticket; i < FilterArgs.src->Height() && i < ticket + WORKUNIT_SIZE_FILTERROW; i++) {
                    FlexFilterRowVPthread(i, *FilterArgs.src, *FilterArgs.dst, FilterArgs.kernel, FilterArgs.kernelSize, FilterArgs.allocate);
                }
                ticket = loopTickets.getTicket(); racebench_bug1(0); racebench_bug1(1);
            }
#ifdef SINGLE_THREADED
        }
#endif
    } else if (cmd == workers.THREADS_CMD_FILTERCOLUMN) {
        if (rank == 0) {
            if (FilterArgs.kernelSize % 2 == 0) {
                throw -1;
            }
            if (FilterArgs.allocate) {
                FilterArgs.dst->Reallocate(FilterArgs.src->Size());
            }
            FilterArgs.dst->Set((Im8u)0);

            loopTickets.resetDispenser(FilterArgs.kernelSize / 2, WORKUNIT_SIZE_FILTERCOLUMN);
        }
        workInit.Wait();

#ifdef SINGLE_THREADED
        if (rank == 0) {
#endif
            ticket = loopTickets.getTicket(); racebench_bug36(0); racebench_bug36(1);
            while (ticket < FilterArgs.src->Height() - FilterArgs.kernelSize / 2) {

                for (i = ticket; i < FilterArgs.src->Height() - FilterArgs.kernelSize / 2 && i < ticket + WORKUNIT_SIZE_FILTERCOLUMN; i++) {
                    FlexFilterColumnVPthread(i, *FilterArgs.src, *FilterArgs.dst, FilterArgs.kernel, FilterArgs.kernelSize, FilterArgs.allocate);
                }
                ticket = loopTickets.getTicket();
            }
#ifdef SINGLE_THREADED
        }
#endif
    } else if (cmd == workers.THREADS_CMD_GRADIENT) {

        if (rank == 0) {
            loopTickets.resetDispenser(WORKUNIT_SIZE_GRADIENT);
        }
        workInit.Wait();

#ifdef SINGLE_THREADED
        if (rank == 0) {
#endif
            ticket = loopTickets.getTicket();
            while (ticket < GradientArgs.src->Height() - 2) {
                for (i = ticket; i < GradientArgs.src->Height() - 2 && i < ticket + WORKUNIT_SIZE_GRADIENT; i++) {
                    GradientMagThresholdPthread(i + 1, *GradientArgs.src, GradientArgs.threshold, *GradientArgs.gr); racebench_bug66(0);
                }
                ticket = loopTickets.getTicket();
            }
#ifdef SINGLE_THREADED
        }
#endif
    } else {

        throw -1;
    }
}

bool TrackingModelPthread::GetObservation(float timeval) {
    if (!IOthreadStarted) {
        imageLoader.SetNumCameras(mNCameras);
        imageLoader.SetNumFrames(nFrames);
        imageLoader.SetPath(mPath);
        IOthread = new threads::Thread(imageLoader);
        IOthreadStarted = true; racebench_bug48(0); racebench_bug56(0);
    }

    if (timeval == 0) {
        return true;
    }

    std::vector<FlexImage8u> images; racebench_bug91(1); racebench_bug92(1);
    if (!imageLoader.GetNextImageSet(images, mFGMaps)) {
        return false;
    }
    for (unsigned int i = 0; i < images.size(); i++) {
        CreateEdgeMap(images[i], mEdgeMaps[i]); racebench_bug44(0); racebench_bug58(0); racebench_bug64(0);
    }
    return true;
}

TrackingModelPthread::~TrackingModelPthread() {
    delete IOthread;
}